
// This file is automatically generated. Do not edit it directly.
import { createClient } from '@supabase/supabase-js';
import type { Database } from './types';

const SUPABASE_URL = "https://kkiymeuqlznkpiqdedgz.supabase.co";
const SUPABASE_PUBLISHABLE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtraXltZXVxbHpua3BpcWRlZGd6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDEzMjYwNjMsImV4cCI6MjA1NjkwMjA2M30.aAsK16xq_dvzYBbj8HfmGGmTX5NUu1Xipe6CwbLDAe0";

// Exportamos la configuración de Supabase para que pueda ser utilizada en otros componentes
export const SUPABASE_CONFIG = {
  url: SUPABASE_URL,
  key: SUPABASE_PUBLISHABLE_KEY
};

// Configuración de opciones avanzadas para mejorar la estabilidad
const supabaseOptions = {
  auth: {
    autoRefreshToken: true,
    persistSession: true,
  },
  // Incrementamos significativamente los tiempos de espera para redes muy lentas
  global: {
    headers: {
      'x-application-name': 'wasteless-app'
    },
    fetch: (url: RequestInfo | URL, options?: RequestInit) => {
      const controller = new AbortController();
      const { signal } = controller;
      
      // Incrementamos el timeout a 60 segundos para evitar los problemas de AbortError
      const timeoutId = setTimeout(() => controller.abort(), 60000);
      
      return fetch(url, { 
        ...options, 
        signal,
        // Desactivamos caché para evitar problemas con datos desactualizados
        cache: 'no-store'
      })
        .finally(() => clearTimeout(timeoutId));
    }
  },
  realtime: {
    // Configuración optimizada para realtime con tiempos más largos
    timeout: 60000,
    heartbeatIntervalMs: 30000
  }
};

// Import the supabase client like this:
// import { supabase } from "@/integrations/supabase/client";

export const supabase = createClient<Database>(SUPABASE_URL, SUPABASE_PUBLISHABLE_KEY, supabaseOptions);

// Añadimos evento para monitorear la conexión
supabase.auth.onAuthStateChange((event) => {
  console.log("Auth state changed:", event);
  if (event === 'SIGNED_OUT') {
    // Limpiamos la caché local al cerrar sesión
    localStorage.removeItem('supabase-auth');
  }
});

// Función de utilidad para probar la conexión con tiempos de espera más largos
export const testSupabaseConnection = async (): Promise<boolean> => {
  try {
    console.log("Intentando conectar a Supabase con timeout extendido...");
    const startTime = Date.now();
    
    // Timeout manual para prevenir bloqueos
    const timeoutPromise = new Promise<boolean>((_, reject) => {
      setTimeout(() => reject(new Error("Timeout manual de conexión alcanzado")), 45000);
    });
    
    // Consulta simple para probar conexión
    const queryPromise = supabase.from('profiles')
      .select('count')
      .limit(1)
      .maybeSingle()
      .then(({ error }) => {
        if (error) {
          console.error("Error de conexión con Supabase:", error);
          return false;
        }
        return true;
      });
    
    // Usar Promise.race para aplicar timeout manual
    const isConnected = await Promise.race([queryPromise, timeoutPromise]);
    
    const latency = Date.now() - startTime;
    console.log(`Latencia de Supabase: ${latency}ms`);
    
    return isConnected;
  } catch (error) {
    console.error("Error al probar conexión con Supabase:", error);
    return false;
  }
};
